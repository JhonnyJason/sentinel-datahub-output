(()=>{"use strict";var t={n:e=>{var n=e&&e.__esModule?()=>e.default:()=>e;return t.d(n,{a:n}),n},d:(e,n)=>{for(var r in n)t.o(n,r)&&!t.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:n[r]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{checkAccessMS:()=>X,checkSymbolsMS:()=>Y,mrktStackSecret:()=>V,name:()=>tt,persistentStateOptions:()=>nt,trdvtCid:()=>Z,trdvtPassword:()=>B,trdvtSecret:()=>L,trdvtUsername:()=>W,urlMrktStack:()=>Q,urlTrdvt:()=>K,version:()=>et});var n={};t.r(n),t.d(n,{executeSpecialMission:()=>lt,getStockAllHistory:()=>ot,getStockNewerHistory:()=>st,getStockOlderHistory:()=>it,initialize:()=>at});var r={};t.r(r),t.d(r,{initialize:()=>Gt,load:()=>Rt,remove:()=>Ft,save:()=>Jt});var a={};t.r(a),t.d(a,{initialize:()=>ae});var o={};t.r(o),t.d(o,{executeSpecialMission:()=>le,getData:()=>ue,initialize:()=>se});var i={};t.r(i);var s={};t.r(s),t.d(s,{prepareAndExpose:()=>ke});var l={};t.r(l),t.d(l,{initialize:()=>Ee,startSession:()=>Te});var u={};t.r(u),t.d(u,{serviceStartup:()=>be});const c=require("node:path");var d=t.n(c);const h=require("node:fs");var f,m,p=t.n(h);m=function(t){return JSON.stringify(t,null,4)},f={};var v=function(t){var e,n;return n=function(t){return e("\n"+m(t))},{log:e=function(e){f[t]&&console.log("["+t+"]: "+e)},olog:n}};const y=require("node:net");var g,w,S,k,E,x=t.n(y);({log:g,olog:w}=v("bugsnitch")),S=new Promise(function(t){return t}),E="unnamed",k=async function(t){var e;g("sendToBugsnitch"),await S,(e=x().createConnection("/run/bugsnitch.sk")).on("connect",function(){return e.end(t)}),e.on("error",function(t){return console.error(t)}),e.on("close",function(){return g("Connection closed!")})};var D,T,b,$,O=function(t){var e,n;if(g("report"),console.error(t),"string"!=typeof t)try{return n=`[${E}] Error: `+t.message,t.cause&&(n+="\n Cause: "+t.cause),t.stack&&(n+="\n Stack: "+t.stack),void k(n)}catch(t){e=t,console.error("bugsnitch.report: unexpected errorObject!\n "+e.message)}else k(n=`[${E}]: ${t}`)};T=Object.create(null);try{D=d().resolve(process.cwd(),"./.config.json"),b=p().readFileSync(D,"utf8"),T=JSON.parse(b)}catch(t){$="@configmodule - config parsing:\n",$+=" Local Config File could not be read or parsed!\n ",$+=t.message,O($)}var C,A,N,P,j,z,M,_,J,R,F,I,q,G,U,H,L=T.secret||"none",Z=T.cid||"none",W=T.name||"none",B=T.password||"none",V=T.mrktStackSecret||"none",K="https://live.tradovateapi.com/v1",Q="https://api.marketstack.com/v2",X=6e5,Y=36e5,tt="Sentinel Datahub",et="v0.0.1",nt={basePath:"../state",maxCacheSize:128},rt=[].indexOf;({log:I,olog:G}=v("marketstackmodule")),C=null,N=null,d().resolve(".","symbols.json"),j=d().resolve(".","currencies.json"),P=[],A=!1;var at=function(t){I("initialize"),null!=t.mrktStackSecret&&(C=t.mrktStackSecret),null!=t.urlMrktStack&&(N=t.urlMrktStack)},ot=async function(t){var e,n,r;return I(`getStockAllHistory: ${t}`),null==(r=await z(t))?null:(null!=r.error&&(n=r.error,F(n)?I(`Plan limit reached: ${n.code}`):I(`API error: ${n.code}: ${n.message}`)),0===r.data.length?(I("No data received"),null):(e=q(r.data,t),(e=_(e)).meta.historyComplete=null==r.error,I(`Returning ${e.data.length} data points, historyComplete: ${e.meta.historyComplete}`),e))},it=function(t,e){return I(`getStockOlderHistory: ${t} olderThan=${e}`),null},st=function(t,e){return I(`getStockNewerHistory: ${t} newerThan=${e}`),null};z=async function(t){var e,n,r,a,o,i,s,l;if(I(`fetchAllEodPages: ${t}`),A)return null;try{for(A=!0,e=[],o=0,l=performance.now(),n=0;;){if(i=await M(t,{offset:o,limit:1e3}),n++,null!=(r=i.error))return{error:r,data:e};if(e.push(...i.data),s=i.pagination,e.length>=s.total)return{data:e};o+=1e3,n%5==0&&((a=1001-(performance.now()-l))>0&&await H(a),I(`counter: ${n} => missingPerdiodMS: ${a}`),l=performance.now())}}catch(t){return I(r=t)}finally{A=!1}},M=async function(t,{offset:e,limit:n}){var r,a,o,i,s,l;I(`fetchEodPage: ${t} offset=${e}`),r=t.replace(/\./g,"-"),i=new URLSearchParams({access_key:C,symbols:r,sort:"ASC",limit:n.toString(),offset:e.toString()}),l=`${N}/eod?${i.toString()}`;try{s=await fetch(l)}catch(t){return I(`Network error: ${(o=t).message}`),{error:{code:"network_error",message:o.message}}}try{return null!=(a=await s.json()).error?{error:a.error}:{data:a.data,pagination:a.pagination}}catch(t){return I(`Parse error: ${(o=t).message}`),{error:{code:"parse_error",message:o.message}}}},q=function(t,e){var n,r,a,o,i;if(I(`normalizeEodResponse: ${t.length} records`),0===t.length)return null;for(n=[],a=0,o=t.length;a<o;a++)r=(i=t[a]).date.substring(0,10),n.push({date:r,high:i.high,low:i.low,close:i.close});return{meta:{startDate:n[0].date,endDate:n[n.length-1].date,interval:"1d"},data:n.map(function(t){return[t.high,t.low,t.close]}),_dates:n.map(function(t){return t.date})}},_=function(t){var e,n,r,a,o,i,s,l,u,c,d,h,f;if(I("gapFillDataSet"),null==t||0===t.data.length)return t;for(({meta:h,data:r,_dates:e}=t),o={},s=l=0,f=e.length;0<=f?l<f:l>f;s=0<=f?++l:--l)o[e[s]]=r[s];for(n=J(h.startDate,h.endDate),i=[],c=r[0][2],u=0,d=n.length;u<d;u++)null!=o[a=n[u]]?(i.push(o[a]),c=o[a][2]):i.push([c,c,c]);return{meta:h,data:i}},J=function(t,e){var n,r,a;for(r=[],n=new Date(t+"T00:00:00Z"),a=new Date(e+"T00:00:00Z");n<=a;)r.push(n.toISOString().substring(0,10)),n.setUTCDate(n.getUTCDate()+1);return r},F=function(t){var e,n;return e=["function_access_restricted","https_access_restricted","usage_limit_reached"],n=t.code,rt.call(e,n)>=0};var lt=async function(){I("executeSpecialMission"),await U(),I("sepcialMission ended... bye!")};H=function(t){return new Promise(function(e){return setTimeout(e,t)})},U=async function(){var t,e,n,r,a;for(I("storeRelevantCurrencies"),a=await R(),I(`results retrieved: ${a.length}`),G(a[0]),n=0,r=a.length;n<r;n++)e=a[n],P.push(e);t=JSON.stringify(P,null,4),p().writeFileSync(j,t)},R=async function(){var t,e,n,r,a,o,i;I("getAllCurrencies"),n=new URLSearchParams({access_key:C,limit:1e3,offset:0}),i=N+"/currencies?"+n.toString(),t=[];try{r=await fetch(i)}catch(t){e=t,console.error(e)}try{if(r.ok){if(null!=(a=await r.json()).error)throw new Error(a.error.code+": "+a.error.message);return I("retrieved result!"),G(a.pagination),G(a.data[0]),t.push(...a.data),1e3!==a.pagination.limit&&console.error(`Pagination Limit did not match our provided Limit! ${a.pagination.limit} vs 1000`),0!==a.pagination.offset&&console.error(`Pagination Offset did not match our offset! ${a.pagination.offset} vs 0`),t}console.error("status: "+r.status),o=await r.text(),console.error(o)}catch(t){e=t,console.error(e)}return t};const ut=require("path");var ct=t.n(ut);const dt=require("fs");var ht,ft,mt,pt,vt,yt,gt=t.n(dt);mt=gt().promises,ft=null;var wt,St,kt,Et,xt,Dt,Tt,bt,$t,Ot,Ct,At,Nt,Pt,jt,zt=function(t){var e;null==t&&(t="./state"),e=ct().isAbsolute(t)?t:ct().resolve(process.cwd(),t),ft=e,gt().existsSync(ft)||gt().mkdirSync(ft)};vt=function(t){var e;return e=t+".json",ct().resolve(ft,e)},pt=function(t){return t+".backup"},ht=function(t){var e,n;e=pt(t);try{gt().copyFileSync(t,e)}catch(e){throw n="Error: backing up state failed!\n",n+="file: "+t+"\n",n+="reason: "+e.message,new Error(n)}},yt=function(t){var e,n,r,a;a=vt(t),e=pt(a);try{return n=gt().readFileSync(e,"utf-8"),r=JSON.parse(n),mt.writeFile(a,n),{contentObj:r,contentJson:n}}catch(t){return{contentObj:r=null,contentJson:n=null}}},({log:Ct,olog:Pt}=v("statecachemodule")),bt={},Nt={},St=null,Et=null,Tt={},kt=0,At=64,Dt=null,wt=class{constructor(t){this.id=t,this.nextEntry=null,this.previousEntry=St,null==Et&&(Et=this),null!=St&&(St.nextEntry=this),St=this,Tt[this.id]=this,++kt>At&&xt()}touch(){null!=this.nextEntry&&(null!=this.previousEntry?(this.nextEntry.previousEntry=this.previousEntry,this.previousEntry.nextEntry=this.nextEntry):(Et=this.nextEntry,this.nextEntry.previousEntry=null),this.nextEntry=null,this.previousEntry=St,null!=St&&(St.nextEntry=this),St=this)}remove(){return null!=this.nextEntry&&null!=this.previousEntry&&(this.nextEntry.previousEntry=this.previousEntry,this.previousEntry.nextEntry=this.nextEntry),null==this.nextEntry&&null==this.previousEntry&&(St=null,Et=null),null!=this.nextEntry&&null==this.previousEntry&&(this.nextEntry.previousEntry=null,Et=this.nextEntry),null==this.nextEntry&&null!=this.previousEntry&&(this.previousEntry.nextEntry=null,St=this.previousEntry),jt(this.id)}toString(){var t;return t=this.id+"\n",null!=this.nextEntry?t+="  next: "+this.nextEntry.id+"\n":t+="  next: null\n",null!=this.previousEntry?t+="  previous: "+this.previousEntry.id+"\n":t+="  previous: null\n",t}},$t=function(t){var e,n;new wt(t),({contentObj:n,contentJson:e}=function(t){var e,n;n=vt(t);try{return e=gt().readFileSync(n,"utf-8"),{contentObj:JSON.parse(e),contentJson:e}}catch(e){return yt(t)}}(t)),null!=n?(bt[t]=e,Nt[t]=n):Ot(t)},Ot=function(t){null==Dt||null==Dt[t]?(bt[t]="{}",Nt[t]={}):(bt[t]=JSON.stringify(Dt[t]),Nt[t]=JSON.parse(bt[t]))},jt=function(t){delete Nt[t],delete bt[t],delete Tt[t],kt--},xt=function(){var t;null!=(t=Et)&&(null!=(Et=t.nextEntry)&&(Et.previousEntry=null),jt(t.id))};var Mt,_t,Jt=async function(t,e){var n;null!=Tt[t]?Tt[t].touch():new wt(t),e&&(Nt[t]=e),(n=JSON.stringify(Nt[t]))!==bt[t]&&(bt[t]=n,await function(t,e){var n;n=vt(t),gt().writeFileSync(n,e),ht(n)}(t,n))},Rt=function(t){return null==Nt[t]?$t(t):Tt[t].touch(),Nt[t]},Ft=async function(t){var e;null!=(e=Tt[t])&&(e.remove(),await async function(t){var e,n,r,a;a=vt(t),e=pt(a),n=mt.unlink(a),r=mt.unlink(e);try{await Promise.all([n,r])}catch(t){return}}(t))};({log:Mt,olog:_t}=v("storagemodule"));var It,qt,Gt=function(t){var e;Mt("initialize"),(e=t.persistentStateOptions)?(Dt=e.defaultState,null!=e.maxCacheSize&&(At=e.maxCacheSize),zt(e.basePath)):zt()};({log:It,olog:qt}=v("symbolsmodule"));var Ut,Ht,Lt,Zt,Wt,Bt,Vt,Kt,Qt,Xt,Yt,te,ee,ne,re,ae=function(){It("initialize")};({log:Yt,olog:ee}=v("datamodule")),re=function(t){return`did:${t.replace(".","-")}`},Zt=5;var oe,ie,se=function(t){Yt("initialize"),null!=t.freshnessThreshold&&(Zt=t.freshnessThreshold)},le=async function(){var t,e,n;Yt("executeSpecialMission"),n=performance.now(),e=await ue("GOOGL"),Yt(`full data retrieval took ${performance.now()-n}ms`),t=e.data.length,ee(e.meta),Yt(t),ee(e.data[0]),ee(e.data[t-1])},ue=function(t){return Yt(`getData ${t}`),Kt(t)?Wt(t):Qt(t)?Bt(t):Vt(t)};Kt=function(t){return Yt("isCommodityName"),!1},Qt=function(t){return Yt("isForexPair"),!1},Vt=async function(t){var e,n,r,a;return Yt(`getStockData ${t}`),n=re(t),null==(e=Rt(n)).data?(null!=(e=await ot(t))&&Jt(n,e),e):(e.meta.historyComplete||null!=(a=await it(t,e.meta.startDate))&&(e=ne(a,e),Jt(n,e)),Xt(e)||null!=(r=await st(t,e.meta.endDate))&&(e=Ut(e,r),Jt(n,e)),e)},Xt=function(t){var e,n,r;return null!=(null!=t&&null!=(r=t.meta)?r.endDate:void 0)&&(e=new Date(t.meta.endDate+"T00:00:00Z"),n=new Date,Math.floor((n-e)/864e5)<=Zt)},ne=function(t,e){var n,r,a,o;return r=[],n=te(t.meta.endDate),(a=Ht(n,e.meta.startDate))>0&&(Yt(`WARNING: gap detected between ${t.meta.endDate} and ${e.meta.startDate}`),o=t.data[t.data.length-1][2],r=Lt(a,o)),a<0&&(Yt("WARNING: gap was negative! This should NEVER happen!"),t.data=t.data.slice(0,a)),{meta:{startDate:t.meta.startDate,endDate:e.meta.endDate,interval:e.meta.interval,historyComplete:t.meta.historyComplete},data:[...t.data,...r,...e.data]}},Ut=function(t,e){var n,r,a,o;return r=[],n=te(t.meta.endDate),(a=Ht(n,e.meta.startDate))>0&&(Yt(`WARNING: gap detected between ${t.meta.endDate} and ${e.meta.startDate}`),o=t.data[t.data.length-1][2],r=Lt(a,o)),a<0&&(Yt("WARNING: gap was negative! This should NEVER happen!"),e.data=e.data.slice(Math.abs(a))),{meta:{startDate:t.meta.startDate,endDate:e.meta.endDate,interval:t.meta.interval,historyComplete:t.meta.historyComplete},data:[...t.data,...r,...e.data]}},Lt=function(t,e){return Array(t).fill([e,e,e])},te=function(t){var e;return(e=new Date(t+"T00:00:00Z")).setUTCDate(e.getUTCDate()+1),e.toISOString().substring(0,10)},Ht=function(t,e){var n,r;return r=new Date(t+"T00:00:00Z"),n=new Date(e+"T00:00:00Z"),Math.floor((n-r)/864e5)},Wt=function(t){var e;return Yt("getCommodityData"),e=re(t),Rt(e)},Bt=function(t){return Yt("getForexPairData"),re(t),{}},function(t){var e;for(e in t)t[e]&&(f[e]=!0)}({datamodule:!0,marketstackmodule:!0,scimodule:!0,startupmodule:!0}),({log:oe,olog:ie}=v("scimodule"));var ce,de,he,fe,me,pe,ve,ye,ge,we,Se,ke=function(){oe("prepareAndExpose")};({log:fe,olog:me}=v("tradovatemodule")),Se=null,we=null;var Ee=function(t){fe("initialize")};ge=function(t){fe("saveStorage"),t&&(we=t),Jt("datahubState",we)},he=async function(t,e){var n,r,a,o;fe("getRequest"),r={method:"GET",headers:{"Content-Type":"application/json",Accept:"application/json"}},null!=e&&(r.headers.Authorization=`Bearer ${e}`);try{a=await fetch(t,r)}catch(t){n=t,console.error(n)}try{if(a.ok)return await a.json();console.error("status: "+a.status),o=await a.text(),console.error(o)}catch(t){n=t,console.error(n)}},pe=async function(t,e,n){var r,a,o,i;fe("postRequest"),a={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)},null!=n&&(a.headers.Authorization=`Bearer ${n}`);try{o=await fetch(t,a)}catch(t){r=t,console.error(r)}try{if(o.ok)return await o.json();console.error("status: "+o.status),i=await o.text(),console.error(i)}catch(t){r=t,console.error(r)}},ve=async function(){var t,e;fe("refreshToken"),e=Se+"/auth/renewAccessToken",t=await he(e,we.accessToken),me(t),null!=t.accessToken&&(we.accessToken=t.accessToken),null!=t.mdAccessToken&&(we.mdAccessToken=t.mdAccessToken),null!=t.expirationTime&&(we.expirationTime=t.expirationTime),ge()},ye=async function(){var t,e,n;fe("requestAccessToken"),e={name:null,password:null,appId:"sentinel",appVersion:null,cid:null,sec:null},n=Se+"/auth/accesstokenrequest",t=await pe(n,e),me(t),null!=t&&ge(t)},de=function(){var t,e,n,r;return fe("ensureFreshToken"),null==(e=we.expirationTime)?ye():(t=new Date(e).getTime(),n=(new Date).getTime(),me({exp:t,now:n,timeToExpiry:r=t-n}),r<0?ye():r<114e4?ve():void 0)},ce=async function(){var t,e;fe("checkSymbols"),fe("using url: "+(e=Se+"/product/list")),t=await he(e,we.mdAccessToken),me(t)};var xe,De,Te=async function(t){fe("startSession"),t&&await ye(),await de(),setInterval(de,6e5),await ce(),setInterval(ce,36e5)};({log:xe,olog:De}=v("startupmodule"));var be=async function(){xe("serviceStartup"),await le()};const $e={configmodule:e,datamodule:o,debugmodule:i,marketstackmodule:n,scimodule:s,startupmodule:u,storagemodule:r,symbolsmodule:a,tradovatemodule:l};global.allModules=$e,async function(){var t,n,r;try{return r=function(){var r;for(n in r=[],$e)null!=(t=$e[n]).initialize&&r.push(t.initialize(e));return r}(),await Promise.all(r),await $e.startupmodule.serviceStartup()}catch(t){return O("@run: "+t.message)}}()})();