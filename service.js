(()=>{"use strict";var e={n:t=>{var n=t&&t.__esModule?()=>t.default:()=>t;return e.d(n,{a:n}),n},d:(t,n)=>{for(var r in n)e.o(n,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:n[r]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{checkAccessMS:()=>_,checkSymbolsMS:()=>L,mrktStackSecret:()=>F,name:()=>R,persistentStateOptions:()=>D,trdvtCid:()=>C,trdvtPassword:()=>$,trdvtSecret:()=>M,trdvtUsername:()=>q,urlMrktStack:()=>N,urlTrdvt:()=>J,version:()=>B});var n={};e.r(n),e.d(n,{initialize:()=>Y});var r={};e.r(r);var o={};e.r(o),e.d(o,{executeSpecialMission:()=>ne,initialize:()=>te});var i={};e.r(i),e.d(i,{prepareAndExpose:()=>re});var s={};e.r(s),e.d(s,{initialize:()=>Me,startSession:()=>$e});var a={};e.r(a),e.d(a,{serviceStartup:()=>Ne});var l={};e.r(l),e.d(l,{initialize:()=>Re});var u={};e.r(u),e.d(u,{initialize:()=>Be});const c=require("node:path");var d=e.n(c);const v=require("node:fs");var p,h,y=e.n(v);h=function(e){return JSON.stringify(e,null,4)},p={};var f=function(e){var t,n;return n=function(e){return t("\n"+h(e))},{log:t=function(t){p[e]&&console.log("["+e+"]: "+t)},olog:n}};const m=require("node:net");var g,E,k,S,w,x=e.n(m);({log:g,olog:E}=f("bugsnitch")),k=new Promise(function(e){return e}),w="unnamed",S=async function(e){var t;g("sendToBugsnitch"),await k,(t=x().createConnection("/run/bugsnitch.sk")).on("connect",function(){return t.end(e)}),t.on("error",function(e){return console.error(e)}),t.on("close",function(){return g("Connection closed!")})};var b,T,j,z,O=function(e){var t,n;if(g("report"),console.error(e),"string"!=typeof e)try{return n=`[${w}] Error: `+e.message,e.cause&&(n+="\n Cause: "+e.cause),e.stack&&(n+="\n Stack: "+e.stack),void S(n)}catch(e){t=e,console.error("bugsnitch.report: unexpected errorObject!\n "+t.message)}else S(n=`[${w}]: ${e}`)};T=Object.create(null);try{b=d().resolve(process.cwd(),"./.config.json"),j=y().readFileSync(b,"utf8"),T=JSON.parse(j)}catch(e){z="@configmodule - config parsing:\n",z+=" Local Config File could not be read or parsed!\n ",z+=e.message,O(z)}var A,P,M=T.secret||"none",C=T.cid||"none",q=T.name||"none",$=T.password||"none",F=T.mrktStackSecret||"none",J="https://live.tradovateapi.com/v1",N="https://api.marketstack.com/v2",_=6e5,L=36e5,R="Sentinel Datahub",B="v0.0.1",D={basePath:"../state",maxCacheSize:128};({log:A,olog:P}=f("datamodule"));var I,U,G,V,H,K,Q,W,X,Y=function(){A("initialize")};(function(e){var t;for(t in e)e[t]&&(p[t]=!0)})({bugsnitch:!0,marketstackmodule:!0,scimodule:!0,startupmodule:!0,tradovatemodule:!0}),({log:K,olog:Q}=f("marketstackmodule")),I=null,U=null,d().resolve(".","symbols.json"),V=d().resolve(".","currencies.json"),G=[];var Z,ee,te=function(e){K("initialize"),null!=e.mrktStackSecret&&(I=e.mrktStackSecret),null!=e.urlMrktStack&&(U=e.urlMrktStack)},ne=async function(){K("executeSpecialMission"),await W(),K("sepcialMission ended... bye!")};X=function(e){return new Promise(function(t){return setTimeout(t,e)})},W=async function(){var e,t,n,r,o;for(K("storeRelevantCurrencies"),o=await H(),K(`results retrieved: ${o.length}`),Q(o[0]),n=0,r=o.length;n<r;n++)t=o[n],G.push(t);e=JSON.stringify(G,null,4),y().writeFileSync(V,e)},H=async function(){var e,t,n,r,o,i,s;K("getAllCurrencies"),n=new URLSearchParams({access_key:I,limit:1e3,offset:0}),s=U+"/currencies?"+n.toString(),e=[];try{r=await fetch(s)}catch(e){t=e,console.error(t)}try{if(r.ok){if(null!=(o=await r.json()).error)throw new Error(o.error.code+": "+o.error.message);return K("retrieved result!"),Q(o.pagination),Q(o.data[0]),e.push(...o.data),1e3!==o.pagination.limit&&console.error(`Pagination Limit did not match our provided Limit! ${o.pagination.limit} vs 1000`),0!==o.pagination.offset&&console.error(`Pagination Offset did not match our offset! ${o.pagination.offset} vs 0`),e}console.error("status: "+r.status),i=await r.text(),console.error(i)}catch(e){t=e,console.error(t)}return e},({log:Z,olog:ee}=f("scimodule"));var re=function(){Z("prepareAndExpose")};const oe=require("path"),ie=require("fs");var se,ae,le,ue,ce,de,ve,pe,he,ye,fe,me,ge,Ee;ae=ie.promises,ue=function(e){var t;return t=e+".json",oe.resolve(null,t)},le=function(e){return e+".backup"},se=function(e){var t,n;t=le(e);try{ie.copyFileSync(e,t)}catch(t){throw n="Error: backing up state failed!\n",n+="file: "+e+"\n",n+="reason: "+t.message,new Error(n)}},ge=function(e){return JSON.stringify(e,null,4)},fe={},me={},de=null,pe=null,ye={},ve=0,ce=class{constructor(e){this.id=e,this.nextEntry=null,this.previousEntry=de,null==pe&&(pe=this),null!=de&&(de.nextEntry=this),de=this,ye[this.id]=this,++ve>64&&he()}touch(){null!=this.nextEntry&&(null!=this.previousEntry?(this.nextEntry.previousEntry=this.previousEntry,this.previousEntry.nextEntry=this.nextEntry):(pe=this.nextEntry,this.nextEntry.previousEntry=null),this.nextEntry=null,this.previousEntry=de,null!=de&&(de.nextEntry=this),de=this)}remove(){return null!=this.nextEntry&&null!=this.previousEntry&&(this.nextEntry.previousEntry=this.previousEntry,this.previousEntry.nextEntry=this.nextEntry),null==this.nextEntry&&null==this.previousEntry&&(de=null,pe=null),null!=this.nextEntry&&null==this.previousEntry&&(this.nextEntry.previousEntry=null,pe=this.nextEntry),null==this.nextEntry&&null!=this.previousEntry&&(this.previousEntry.nextEntry=null,de=this.previousEntry),Ee(this.id)}toString(){var e;return e=this.id+"\n",null!=this.nextEntry?e+="  next: "+this.nextEntry.id+"\n":e+="  next: null\n",null!=this.previousEntry?e+="  previous: "+this.previousEntry.id+"\n":e+="  previous: null\n",e}},Ee=function(e){delete me[e],delete fe[e],delete ye[e],ve--},he=function(){var e;null!=(e=pe)&&(null!=(pe=e.nextEntry)&&(pe.previousEntry=null),Ee(e.id))};var ke,Se,we,xe,be,Te,je,ze,Oe,Ae,Pe;({log:xe,olog:be}=f("tradovatemodule")),Pe=null,Ae=null;var Me=function(e){xe("initialize")};Oe=function(e){xe("saveStorage"),e&&(Ae=e),async function(e,t){var n;null!=ye[e]?ye[e].touch():new ce(e),t&&(me[e]=t),(n=ge(me[e]))!==fe[e]&&(fe[e]=n,await function(e,t){var n;n=ue(e),ie.writeFileSync(n,t),se(n)}(e,n))}("datahubState",Ae)},we=async function(e,t){var n,r,o,i;xe("getRequest"),r={method:"GET",headers:{"Content-Type":"application/json",Accept:"application/json"}},null!=t&&(r.headers.Authorization=`Bearer ${t}`);try{o=await fetch(e,r)}catch(e){n=e,console.error(n)}try{if(o.ok)return await o.json();console.error("status: "+o.status),i=await o.text(),console.error(i)}catch(e){n=e,console.error(n)}},Te=async function(e,t,n){var r,o,i,s;xe("postRequest"),o={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)},null!=n&&(o.headers.Authorization=`Bearer ${n}`);try{i=await fetch(e,o)}catch(e){r=e,console.error(r)}try{if(i.ok)return await i.json();console.error("status: "+i.status),s=await i.text(),console.error(s)}catch(e){r=e,console.error(r)}},je=async function(){var e,t;xe("refreshToken"),t=Pe+"/auth/renewAccessToken",e=await we(t,Ae.accessToken),be(e),null!=e.accessToken&&(Ae.accessToken=e.accessToken),null!=e.mdAccessToken&&(Ae.mdAccessToken=e.mdAccessToken),null!=e.expirationTime&&(Ae.expirationTime=e.expirationTime),Oe()},ze=async function(){var e,t,n;xe("requestAccessToken"),t={name:null,password:null,appId:"sentinel",appVersion:null,cid:null,sec:null},n=Pe+"/auth/accesstokenrequest",e=await Te(n,t),be(e),null!=e&&Oe(e)},Se=function(){var e,t,n,r;return xe("ensureFreshToken"),null==(t=Ae.expirationTime)?ze():(e=new Date(t).getTime(),n=(new Date).getTime(),be({exp:e,now:n,timeToExpiry:r=e-n}),r<0?ze():r<114e4?je():void 0)},ke=async function(){var e,t;xe("checkSymbols"),xe("using url: "+(t=Pe+"/product/list")),e=await we(t,Ae.mdAccessToken),be(e)};var Ce,qe,$e=async function(e){xe("startSession"),e&&await ze(),await Se(),setInterval(Se,6e5),await ke(),setInterval(ke,36e5)};({log:Ce,olog:qe}=f("startupmodule"));var Fe,Je,Ne=async function(){Ce("serviceStartup"),await $e()};({log:Fe,olog:Je}=f("storagemodule"));var _e,Le,Re=function(){Fe("initialize")};({log:_e,olog:Le}=f("symbolsmodule"));var Be=function(){_e("initialize")};const De={configmodule:t,datamodule:n,debugmodule:r,marketstackmodule:o,scimodule:i,startupmodule:a,storagemodule:l,symbolsmodule:u,tradovatemodule:s};global.allModules=De,async function(){var e,n,r;try{return r=function(){var r;for(n in r=[],De)null!=(e=De[n]).initialize&&r.push(e.initialize(t));return r}(),await Promise.all(r),await De.startupmodule.serviceStartup()}catch(e){return O("@run: "+e.message)}}()})();