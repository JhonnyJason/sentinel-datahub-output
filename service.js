(()=>{"use strict";var e={n:t=>{var r=t&&t.__esModule?()=>t.default:()=>t;return e.d(r,{a:r}),r},d:(t,r)=>{for(var n in r)e.o(r,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:r[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{checkAccessMS:()=>X,checkSymbolsMS:()=>Y,mrktStackSecret:()=>K,name:()=>ee,persistentStateOptions:()=>re,trdvtCid:()=>H,trdvtPassword:()=>V,trdvtSecret:()=>G,trdvtUsername:()=>Z,urlMrktStack:()=>W,urlTrdvt:()=>Q,version:()=>te});var r={};e.r(r),e.d(r,{executeSpecialMission:()=>le,getStockAllHistory:()=>ae,initialize:()=>oe});var n={};e.r(n),e.d(n,{executeSpecialMission:()=>he,initialize:()=>de});var o={};e.r(o);var a={};e.r(a),e.d(a,{prepareAndExpose:()=>fe});var i={};e.r(i),e.d(i,{initialize:()=>Ie,startSession:()=>Be});var s={};e.r(s),e.d(s,{serviceStartup:()=>Ze});var l={};e.r(l),e.d(l,{initialize:()=>Qe});var u={};e.r(u),e.d(u,{initialize:()=>We});const c=require("node:path");var d=e.n(c);const h=require("node:fs");var f,p,v=e.n(h);p=function(e){return JSON.stringify(e,null,4)},f={};var m=function(e){var t,r;return r=function(e){return t("\n"+p(e))},{log:t=function(t){f[e]&&console.log("["+e+"]: "+t)},olog:r}};const y=require("node:net");var g,w,S,k,E,x=e.n(y);({log:g,olog:w}=m("bugsnitch")),S=new Promise(function(e){return e}),E="unnamed",k=async function(e){var t;g("sendToBugsnitch"),await S,(t=x().createConnection("/run/bugsnitch.sk")).on("connect",function(){return t.end(e)}),t.on("error",function(e){return console.error(e)}),t.on("close",function(){return g("Connection closed!")})};var T,b,$,P,O=function(e){var t,r;if(g("report"),console.error(e),"string"!=typeof e)try{return r=`[${E}] Error: `+e.message,e.cause&&(r+="\n Cause: "+e.cause),e.stack&&(r+="\n Stack: "+e.stack),void k(r)}catch(e){t=e,console.error("bugsnitch.report: unexpected errorObject!\n "+t.message)}else k(r=`[${E}]: ${e}`)};b=Object.create(null);try{T=d().resolve(process.cwd(),"./.config.json"),$=v().readFileSync(T,"utf8"),b=JSON.parse($)}catch(e){P="@configmodule - config parsing:\n",P+=" Local Config File could not be read or parsed!\n ",P+=e.message,O(P)}var A,j,z,C,_,M,D,q,F,N,R,L,I,J,U,B,G=b.secret||"none",H=b.cid||"none",Z=b.name||"none",V=b.password||"none",K=b.mrktStackSecret||"none",Q="https://live.tradovateapi.com/v1",W="https://api.marketstack.com/v2",X=6e5,Y=36e5,ee="Sentinel Datahub",te="v0.0.1",re={basePath:"../state",maxCacheSize:128},ne=[].indexOf;({log:L,olog:J}=m("marketstackmodule")),A=null,z=null,d().resolve(".","symbols.json"),_=d().resolve(".","currencies.json"),C=[],j=!1;var oe=function(e){L("initialize"),null!=e.mrktStackSecret&&(A=e.mrktStackSecret),null!=e.urlMrktStack&&(z=e.urlMrktStack)},ae=async function(e){var t,r,n;return L(`getStockAllHistory: ${e}`),null==(n=await M(e))?null:(null!=n.error&&(r=n.error,R(r)?L(`Plan limit reached: ${r.code}`):L(`API error: ${r.code}: ${r.message}`)),0===n.data.length?(L("No data received"),null):(t=I(n.data,e),(t=q(t)).meta.historyComplete=null==n.error,L(`Returning ${t.data.length} data points, historyComplete: ${t.meta.historyComplete}`),t))};M=async function(e){var t,r,n,o,a,i,s,l;if(L(`fetchAllEodPages: ${e}`),j)return null;try{for(j=!0,t=[],a=0,l=performance.now(),r=0;;){if(i=await D(e,{offset:a,limit:1e3}),r++,null!=(n=i.error))return{error:n,data:t};if(t.push(...i.data),s=i.pagination,t.length>=s.total)return{data:t};a+=1e3,r%5==0&&((o=1001-(performance.now()-l))>0&&await B(o),L(`counter: ${r} => missingPerdiodMS: ${o}`),l=performance.now())}}catch(e){return L(n=e)}finally{j=!1}},D=async function(e,{offset:t,limit:r}){var n,o,a,i,s,l;L(`fetchEodPage: ${e} offset=${t}`),n=e.replace(/\./g,"-"),i=new URLSearchParams({access_key:A,symbols:n,sort:"ASC",limit:r.toString(),offset:t.toString()}),l=`${z}/eod?${i.toString()}`;try{s=await fetch(l)}catch(e){return L(`Network error: ${(a=e).message}`),{error:{code:"network_error",message:a.message}}}try{return null!=(o=await s.json()).error?{error:o.error}:{data:o.data,pagination:o.pagination}}catch(e){return L(`Parse error: ${(a=e).message}`),{error:{code:"parse_error",message:a.message}}}},I=function(e,t){var r,n,o,a,i;if(L(`normalizeEodResponse: ${e.length} records`),0===e.length)return null;for(r=[],o=0,a=e.length;o<a;o++)n=(i=e[o]).date.substring(0,10),r.push({date:n,high:i.high,low:i.low,close:i.close});return{meta:{startDate:r[0].date,endDate:r[r.length-1].date,interval:"1d"},data:r.map(function(e){return[e.high,e.low,e.close]}),_dates:r.map(function(e){return e.date})}},q=function(e){var t,r,n,o,a,i,s,l,u,c,d,h,f;if(L("gapFillDataSet"),null==e||0===e.data.length)return e;for(({meta:h,data:n,_dates:t}=e),a={},s=l=0,f=t.length;0<=f?l<f:l>f;s=0<=f?++l:--l)a[t[s]]=n[s];for(r=F(h.startDate,h.endDate),i=[],c=n[0][2],u=0,d=r.length;u<d;u++)null!=a[o=r[u]]?(i.push(a[o]),c=a[o][2]):i.push([c,c,c]);return{meta:h,data:i}},F=function(e,t){var r,n,o;for(n=[],r=new Date(e+"T00:00:00Z"),o=new Date(t+"T00:00:00Z");r<=o;)n.push(r.toISOString().substring(0,10)),r.setUTCDate(r.getUTCDate()+1);return n},R=function(e){var t,r;return t=["function_access_restricted","https_access_restricted","usage_limit_reached"],r=e.code,ne.call(t,r)>=0};var ie,se,le=async function(){L("executeSpecialMission"),await U(),L("sepcialMission ended... bye!")};B=function(e){return new Promise(function(t){return setTimeout(t,e)})},U=async function(){var e,t,r,n,o;for(L("storeRelevantCurrencies"),o=await N(),L(`results retrieved: ${o.length}`),J(o[0]),r=0,n=o.length;r<n;r++)t=o[r],C.push(t);e=JSON.stringify(C,null,4),v().writeFileSync(_,e)},N=async function(){var e,t,r,n,o,a,i;L("getAllCurrencies"),r=new URLSearchParams({access_key:A,limit:1e3,offset:0}),i=z+"/currencies?"+r.toString(),e=[];try{n=await fetch(i)}catch(e){t=e,console.error(t)}try{if(n.ok){if(null!=(o=await n.json()).error)throw new Error(o.error.code+": "+o.error.message);return L("retrieved result!"),J(o.pagination),J(o.data[0]),e.push(...o.data),1e3!==o.pagination.limit&&console.error(`Pagination Limit did not match our provided Limit! ${o.pagination.limit} vs 1000`),0!==o.pagination.offset&&console.error(`Pagination Offset did not match our offset! ${o.pagination.offset} vs 0`),e}console.error("status: "+n.status),a=await n.text(),console.error(a)}catch(e){t=e,console.error(t)}return e},({log:ie,olog:se}=m("datamodule"));var ue,ce,de=function(){ie("initialize")},he=async function(){var e,t,r;ie("executeSpecialMission"),r=performance.now(),t=await ae("GOOGL"),ie(`full data retrieval took ${performance.now()-r}ms`),e=t.data.length,se(t.meta),ie(e),se(t.data[0]),se(t.data[e-1])};(function(e){var t;for(t in e)e[t]&&(f[t]=!0)})({datamodule:!0,marketstackmodule:!0,scimodule:!0,startupmodule:!0}),({log:ue,olog:ce}=m("scimodule"));var fe=function(){ue("prepareAndExpose")};const pe=require("path"),ve=require("fs");var me,ye,ge,we,Se,ke,Ee,xe,Te,be,$e,Pe,Oe,Ae;ye=ve.promises,we=function(e){var t;return t=e+".json",pe.resolve(null,t)},ge=function(e){return e+".backup"},me=function(e){var t,r;t=ge(e);try{ve.copyFileSync(e,t)}catch(t){throw r="Error: backing up state failed!\n",r+="file: "+e+"\n",r+="reason: "+t.message,new Error(r)}},Oe=function(e){return JSON.stringify(e,null,4)},$e={},Pe={},ke=null,xe=null,be={},Ee=0,Se=class{constructor(e){this.id=e,this.nextEntry=null,this.previousEntry=ke,null==xe&&(xe=this),null!=ke&&(ke.nextEntry=this),ke=this,be[this.id]=this,++Ee>64&&Te()}touch(){null!=this.nextEntry&&(null!=this.previousEntry?(this.nextEntry.previousEntry=this.previousEntry,this.previousEntry.nextEntry=this.nextEntry):(xe=this.nextEntry,this.nextEntry.previousEntry=null),this.nextEntry=null,this.previousEntry=ke,null!=ke&&(ke.nextEntry=this),ke=this)}remove(){return null!=this.nextEntry&&null!=this.previousEntry&&(this.nextEntry.previousEntry=this.previousEntry,this.previousEntry.nextEntry=this.nextEntry),null==this.nextEntry&&null==this.previousEntry&&(ke=null,xe=null),null!=this.nextEntry&&null==this.previousEntry&&(this.nextEntry.previousEntry=null,xe=this.nextEntry),null==this.nextEntry&&null!=this.previousEntry&&(this.previousEntry.nextEntry=null,ke=this.previousEntry),Ae(this.id)}toString(){var e;return e=this.id+"\n",null!=this.nextEntry?e+="  next: "+this.nextEntry.id+"\n":e+="  next: null\n",null!=this.previousEntry?e+="  previous: "+this.previousEntry.id+"\n":e+="  previous: null\n",e}},Ae=function(e){delete Pe[e],delete $e[e],delete be[e],Ee--},Te=function(){var e;null!=(e=xe)&&(null!=(xe=e.nextEntry)&&(xe.previousEntry=null),Ae(e.id))};var je,ze,Ce,_e,Me,De,qe,Fe,Ne,Re,Le;({log:_e,olog:Me}=m("tradovatemodule")),Le=null,Re=null;var Ie=function(e){_e("initialize")};Ne=function(e){_e("saveStorage"),e&&(Re=e),async function(e,t){var r;null!=be[e]?be[e].touch():new Se(e),t&&(Pe[e]=t),(r=Oe(Pe[e]))!==$e[e]&&($e[e]=r,await function(e,t){var r;r=we(e),ve.writeFileSync(r,t),me(r)}(e,r))}("datahubState",Re)},Ce=async function(e,t){var r,n,o,a;_e("getRequest"),n={method:"GET",headers:{"Content-Type":"application/json",Accept:"application/json"}},null!=t&&(n.headers.Authorization=`Bearer ${t}`);try{o=await fetch(e,n)}catch(e){r=e,console.error(r)}try{if(o.ok)return await o.json();console.error("status: "+o.status),a=await o.text(),console.error(a)}catch(e){r=e,console.error(r)}},De=async function(e,t,r){var n,o,a,i;_e("postRequest"),o={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)},null!=r&&(o.headers.Authorization=`Bearer ${r}`);try{a=await fetch(e,o)}catch(e){n=e,console.error(n)}try{if(a.ok)return await a.json();console.error("status: "+a.status),i=await a.text(),console.error(i)}catch(e){n=e,console.error(n)}},qe=async function(){var e,t;_e("refreshToken"),t=Le+"/auth/renewAccessToken",e=await Ce(t,Re.accessToken),Me(e),null!=e.accessToken&&(Re.accessToken=e.accessToken),null!=e.mdAccessToken&&(Re.mdAccessToken=e.mdAccessToken),null!=e.expirationTime&&(Re.expirationTime=e.expirationTime),Ne()},Fe=async function(){var e,t,r;_e("requestAccessToken"),t={name:null,password:null,appId:"sentinel",appVersion:null,cid:null,sec:null},r=Le+"/auth/accesstokenrequest",e=await De(r,t),Me(e),null!=e&&Ne(e)},ze=function(){var e,t,r,n;return _e("ensureFreshToken"),null==(t=Re.expirationTime)?Fe():(e=new Date(t).getTime(),r=(new Date).getTime(),Me({exp:e,now:r,timeToExpiry:n=e-r}),n<0?Fe():n<114e4?qe():void 0)},je=async function(){var e,t;_e("checkSymbols"),_e("using url: "+(t=Le+"/product/list")),e=await Ce(t,Re.mdAccessToken),Me(e)};var Je,Ue,Be=async function(e){_e("startSession"),e&&await Fe(),await ze(),setInterval(ze,6e5),await je(),setInterval(je,36e5)};({log:Je,olog:Ue}=m("startupmodule"));var Ge,He,Ze=async function(){Je("serviceStartup"),await he()};({log:Ge,olog:He}=m("storagemodule"));var Ve,Ke,Qe=function(){Ge("initialize")};({log:Ve,olog:Ke}=m("symbolsmodule"));var We=function(){Ve("initialize")};const Xe={configmodule:t,datamodule:n,debugmodule:o,marketstackmodule:r,scimodule:a,startupmodule:s,storagemodule:l,symbolsmodule:u,tradovatemodule:i};global.allModules=Xe,async function(){var e,r,n;try{return n=function(){var n;for(r in n=[],Xe)null!=(e=Xe[r]).initialize&&n.push(e.initialize(t));return n}(),await Promise.all(n),await Xe.startupmodule.serviceStartup()}catch(e){return O("@run: "+e.message)}}()})();