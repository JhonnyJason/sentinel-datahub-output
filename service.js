(()=>{"use strict";var t={n:e=>{var n=e&&e.__esModule?()=>e.default:()=>e;return t.d(n,{a:n}),n},d:(e,n)=>{for(var r in n)t.o(n,r)&&!t.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:n[r]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{checkAccessMS:()=>L,checkSymbolsMS:()=>V,mrktStackSecret:()=>H,name:()=>K,persistentStateOptions:()=>X,trdvtCid:()=>U,trdvtPassword:()=>Z,trdvtSecret:()=>q,trdvtUsername:()=>G,urlMrktStack:()=>W,urlTrdvt:()=>B,version:()=>Q});var n={};t.r(n),t.d(n,{daysBetween:()=>et,generateDateRange:()=>nt,nextDay:()=>Y,prevDay:()=>tt});var r={};t.r(r),t.d(r,{executeSpecialMission:()=>lt,getStockAllHistory:()=>ot,getStockNewerHistory:()=>st,getStockOlderHistory:()=>it,initialize:()=>at});var a={};t.r(a),t.d(a,{initialize:()=>Ut,load:()=>It,remove:()=>Jt,save:()=>Rt});var o={};t.r(o),t.d(o,{initialize:()=>ne});var i={};t.r(i),t.d(i,{executeSpecialMission:()=>ie,getData:()=>se,initialize:()=>oe});var s={};t.r(s);var l={};t.r(l),t.d(l,{prepareAndExpose:()=>we});var u={};t.r(u),t.d(u,{initialize:()=>Se,startSession:()=>De});var c={};t.r(c),t.d(c,{serviceStartup:()=>xe});const d=require("node:path");var h=t.n(d);const m=require("node:fs");var f,v,p=t.n(m);v=function(t){return JSON.stringify(t,null,4)},f={};var y=function(t){var e,n;return n=function(t){return e("\n"+v(t))},{log:e=function(e){f[t]&&console.log("["+t+"]: "+e)},olog:n}};const g=require("node:net");var w,S,k,E,D,x=t.n(g);({log:w,olog:S}=y("bugsnitch")),k=new Promise(function(t){return t}),D="unnamed",E=async function(t){var e;w("sendToBugsnitch"),await k,(e=x().createConnection("/run/bugsnitch.sk")).on("connect",function(){return e.end(t)}),e.on("error",function(t){return console.error(t)}),e.on("close",function(){return w("Connection closed!")})};var T,b,$,O,C=function(t){var e,n;if(w("report"),console.error(t),"string"!=typeof t)try{return n=`[${D}] Error: `+t.message,t.cause&&(n+="\n Cause: "+t.cause),t.stack&&(n+="\n Stack: "+t.stack),void E(n)}catch(t){e=t,console.error("bugsnitch.report: unexpected errorObject!\n "+e.message)}else E(n=`[${D}]: ${t}`)};b=Object.create(null);try{T=h().resolve(process.cwd(),"./.config.json"),$=p().readFileSync(T,"utf8"),b=JSON.parse($)}catch(t){O="@configmodule - config parsing:\n",O+=" Local Config File could not be read or parsed!\n ",O+=t.message,C(O)}var A,N,P,_,j,z,M,R,I,J,F,q=b.secret||"none",U=b.cid||"none",G=b.name||"none",Z=b.password||"none",H=b.mrktStackSecret||"none",B="https://live.tradovateapi.com/v1",W="https://api.marketstack.com/v2",L=6e5,V=36e5,K="Sentinel Datahub",Q="v0.0.1",X={basePath:"../state",maxCacheSize:128},Y=function(t){var e;return(e=new Date(t+"T00:00:00Z")).setUTCDate(e.getUTCDate()+1),e.toISOString().substring(0,10)},tt=function(t){var e;return(e=new Date(t+"T00:00:00Z")).setUTCDate(e.getUTCDate()-1),e.toISOString().substring(0,10)},et=function(t,e){var n,r;return r=new Date(t+"T00:00:00Z"),n=new Date(e+"T00:00:00Z"),Math.floor((n-r)/864e5)},nt=function(t,e){var n,r,a;for(r=[],n=new Date(t+"T00:00:00Z"),a=new Date(e+"T00:00:00Z");n<=a;)r.push(n.toISOString().substring(0,10)),n.setUTCDate(n.getUTCDate()+1);return r},rt=[].indexOf;({log:R,olog:J}=y("marketstackmodule")),A=null,P=null,h().resolve(".","symbols.json"),h().resolve(".","currencies.json"),N=!1;var at=function(t){R("initialize"),null!=t.mrktStackSecret&&(A=t.mrktStackSecret),null!=t.urlMrktStack&&(P=t.urlMrktStack)},ot=async function(t){var e,n,r;return R(`getStockAllHistory: ${t}`),null==(r=await _(t))?null:(null!=r.error&&(n=r.error,M(n)?R(`Plan limit reached: ${n.code}`):R(`API error: ${n.code}: ${n.message}`)),0===r.data.length?(R("No data received"),null):(e=I(r.data,t),(e=z(e)).meta.historyComplete=null==r.error,R(`Returning ${e.data.length} data points, historyComplete: ${e.meta.historyComplete}`),e))},it=async function(t,e){var n,r,a,o;return R(`getStockOlderHistory: ${t} olderThan=${e}`),r=tt(e),null==(o=await _(t,{date_to:r}))?null:(null!=o.error&&(a=o.error,M(a)?R(`Plan limit reached: ${a.code}`):R(`API error: ${a.code}: ${a.message}`)),0===o.data.length?(R("No older data available"),null):(n=I(o.data,t),(n=z(n)).meta.historyComplete=null==o.error,R(`Returning ${n.data.length} older data points`),n))},st=async function(t,e){var n,r,a,o;return R(`getStockNewerHistory: ${t} newerThan=${e}`),r=Y(e),null==(o=await _(t,{date_from:r}))?null:(null!=o.error&&(a=o.error,M(a)?R(`Plan limit reached: ${a.code}`):R(`API error: ${a.code}: ${a.message}`)),0===o.data.length?(R("No newer data available"),null):(n=I(o.data,t),n=z(n),R(`Returning ${n.data.length} newer data points`),n))};_=async function(t,e={}){var n,r,a,o,i,s,l,u;if(R(`fetchAllEodPages: ${t}`),N)return null;try{for(N=!0,n=[],i=0,u=performance.now(),r=0;;){if(s=await j(t,{offset:i,limit:1e3,...e}),r++,null!=(a=s.error))return{error:a,data:n};if(n.push(...s.data),l=s.pagination,n.length>=l.total)return{data:n};i+=1e3,r%5==0&&((o=1001-(performance.now()-u))>0&&await F(o),R(`counter: ${r} => missingPerdiodMS: ${o}`),u=performance.now())}}catch(t){return R(a=t)}finally{N=!1}},j=async function(t,{offset:e,limit:n,date_from:r,date_to:a}){var o,i,s,l,u,c;R(`fetchEodPage: ${t} offset=${e}`),o=t.replace(/\./g,"-"),l=new URLSearchParams({access_key:A,symbols:o,sort:"ASC",limit:n.toString(),offset:e.toString()}),null!=r&&l.set("date_from",r),null!=a&&l.set("date_to",a),c=`${P}/eod?${l.toString()}`;try{u=await fetch(c)}catch(t){return R(`Network error: ${(s=t).message}`),{error:{code:"network_error",message:s.message}}}try{return null!=(i=await u.json()).error?{error:i.error}:{data:i.data,pagination:i.pagination}}catch(t){return R(`Parse error: ${(s=t).message}`),{error:{code:"parse_error",message:s.message}}}},I=function(t,e){var n,r,a,o,i;if(R(`normalizeEodResponse: ${t.length} records`),0===t.length)return null;for(n=[],a=0,o=t.length;a<o;a++)r=(i=t[a]).date.substring(0,10),n.push({date:r,high:i.high,low:i.low,close:i.close});return{meta:{startDate:n[0].date,endDate:n[n.length-1].date,interval:"1d"},data:n.map(function(t){return[t.high,t.low,t.close]}),_dates:n.map(function(t){return t.date})}},z=function(t){var e,n,r,a,o,i,s,l,u,c,d,h,m;if(R("gapFillDataSet"),null==t||0===t.data.length)return t;for(({meta:h,data:r,_dates:e}=t),o={},s=l=0,m=e.length;0<=m?l<m:l>m;s=0<=m?++l:--l)o[e[s]]=r[s];for(n=nt(h.startDate,h.endDate),i=[],c=r[0][2],u=0,d=n.length;u<d;u++)null!=o[a=n[u]]?(i.push(o[a]),c=o[a][2]):i.push([c,c,c]);return{meta:h,data:i}},M=function(t){var e,n;return e=["function_access_restricted","https_access_restricted","usage_limit_reached"],n=t.code,rt.call(e,n)>=0},F=function(t){return new Promise(function(e){return setTimeout(e,t)})};var lt=function(){R("executeSpecialMission"),R("sepcialMission ended... bye!")};const ut=require("path");var ct=t.n(ut);const dt=require("fs");var ht,mt,ft,vt,pt,yt,gt=t.n(dt);ft=gt().promises,mt=null;var wt,St,kt,Et,Dt,xt,Tt,bt,$t,Ot,Ct,At,Nt,Pt,_t,jt=function(t){var e;null==t&&(t="./state"),e=ct().isAbsolute(t)?t:ct().resolve(process.cwd(),t),mt=e,gt().existsSync(mt)||gt().mkdirSync(mt)};pt=function(t){var e;return e=t+".json",ct().resolve(mt,e)},vt=function(t){return t+".backup"},ht=function(t){var e,n;e=vt(t);try{gt().copyFileSync(t,e)}catch(e){throw n="Error: backing up state failed!\n",n+="file: "+t+"\n",n+="reason: "+e.message,new Error(n)}},yt=function(t){var e,n,r,a;a=pt(t),e=vt(a);try{return n=gt().readFileSync(e,"utf-8"),r=JSON.parse(n),ft.writeFile(a,n),{contentObj:r,contentJson:n}}catch(t){return{contentObj:r=null,contentJson:n=null}}},({log:Ct,olog:Pt}=y("statecachemodule")),bt={},Nt={},St=null,Et=null,Tt={},kt=0,At=64,xt=null,wt=class{constructor(t){this.id=t,this.nextEntry=null,this.previousEntry=St,null==Et&&(Et=this),null!=St&&(St.nextEntry=this),St=this,Tt[this.id]=this,++kt>At&&Dt()}touch(){null!=this.nextEntry&&(null!=this.previousEntry?(this.nextEntry.previousEntry=this.previousEntry,this.previousEntry.nextEntry=this.nextEntry):(Et=this.nextEntry,this.nextEntry.previousEntry=null),this.nextEntry=null,this.previousEntry=St,null!=St&&(St.nextEntry=this),St=this)}remove(){return null!=this.nextEntry&&null!=this.previousEntry&&(this.nextEntry.previousEntry=this.previousEntry,this.previousEntry.nextEntry=this.nextEntry),null==this.nextEntry&&null==this.previousEntry&&(St=null,Et=null),null!=this.nextEntry&&null==this.previousEntry&&(this.nextEntry.previousEntry=null,Et=this.nextEntry),null==this.nextEntry&&null!=this.previousEntry&&(this.previousEntry.nextEntry=null,St=this.previousEntry),_t(this.id)}toString(){var t;return t=this.id+"\n",null!=this.nextEntry?t+="  next: "+this.nextEntry.id+"\n":t+="  next: null\n",null!=this.previousEntry?t+="  previous: "+this.previousEntry.id+"\n":t+="  previous: null\n",t}},$t=function(t){var e,n;new wt(t),({contentObj:n,contentJson:e}=function(t){var e,n;n=pt(t);try{return e=gt().readFileSync(n,"utf-8"),{contentObj:JSON.parse(e),contentJson:e}}catch(e){return yt(t)}}(t)),null!=n?(bt[t]=e,Nt[t]=n):Ot(t)},Ot=function(t){null==xt||null==xt[t]?(bt[t]="{}",Nt[t]={}):(bt[t]=JSON.stringify(xt[t]),Nt[t]=JSON.parse(bt[t]))},_t=function(t){delete Nt[t],delete bt[t],delete Tt[t],kt--},Dt=function(){var t;null!=(t=Et)&&(null!=(Et=t.nextEntry)&&(Et.previousEntry=null),_t(t.id))};var zt,Mt,Rt=async function(t,e){var n;null!=Tt[t]?Tt[t].touch():new wt(t),e&&(Nt[t]=e),(n=JSON.stringify(Nt[t]))!==bt[t]&&(bt[t]=n,await function(t,e){var n;n=pt(t),gt().writeFileSync(n,e),ht(n)}(t,n))},It=function(t){return null==Nt[t]?$t(t):Tt[t].touch(),Nt[t]},Jt=async function(t){var e;null!=(e=Tt[t])&&(e.remove(),await async function(t){var e,n,r,a;a=pt(t),e=vt(a),n=ft.unlink(a),r=ft.unlink(e);try{await Promise.all([n,r])}catch(t){return}}(t))};({log:zt,olog:Mt}=y("storagemodule"));var Ft,qt,Ut=function(t){var e;zt("initialize"),(e=t.persistentStateOptions)?(xt=e.defaultState,null!=e.maxCacheSize&&(At=e.maxCacheSize),jt(e.basePath)):jt()};({log:Ft,olog:qt}=y("symbolsmodule"));var Gt,Zt,Ht,Bt,Wt,Lt,Vt,Kt,Qt,Xt,Yt,te,ee,ne=function(){Ft("initialize")};({log:Xt,olog:Yt}=y("datamodule")),ee=function(t){return`did:${t.replace(".","-")}`},Ht=5;var re,ae,oe=function(t){Xt("initialize"),null!=t.freshnessThreshold&&(Ht=t.freshnessThreshold)},ie=async function(){var t,e,n;Xt("executeSpecialMission"),n=performance.now(),e=await se("GOOGL"),Xt(`full data retrieval took ${performance.now()-n}ms`),t=e.data.length,Yt(e.meta),Xt(t),Yt(e.data[0]),Yt(e.data[t-1])},se=function(t){return Xt(`getData ${t}`),Vt(t)?Bt(t):Kt(t)?Wt(t):Lt(t)};Vt=function(t){return Xt("isCommodityName"),!1},Kt=function(t){return Xt("isForexPair"),!1},Lt=async function(t){var e,n,r,a;return Xt(`getStockData ${t}`),n=ee(t),null==(e=It(n)).data?(null!=(e=await ot(t))&&Rt(n,e),e):(e.meta.historyComplete||null!=(a=await it(t,e.meta.startDate))&&(e=te(a,e),Rt(n,e)),Qt(e)||null!=(r=await st(t,e.meta.endDate))&&(e=Gt(e,r),Rt(n,e)),e)},Qt=function(t){var e,n,r;return null!=(null!=t&&null!=(r=t.meta)?r.endDate:void 0)&&(e=new Date(t.meta.endDate+"T00:00:00Z"),n=new Date,Math.floor((n-e)/864e5)<=Ht)},te=function(t,e){var n,r,a,o;return r=[],n=Y(t.meta.endDate),(a=et(n,e.meta.startDate))>0&&(Xt(`WARNING: gap detected between ${t.meta.endDate} and ${e.meta.startDate}`),o=t.data[t.data.length-1][2],r=Zt(a,o)),a<0&&(Xt("WARNING: gap was negative! This should NEVER happen!"),t.data=t.data.slice(0,a)),{meta:{startDate:t.meta.startDate,endDate:e.meta.endDate,interval:e.meta.interval,historyComplete:t.meta.historyComplete},data:[...t.data,...r,...e.data]}},Gt=function(t,e){var n,r,a,o;return r=[],n=Y(t.meta.endDate),(a=et(n,e.meta.startDate))>0&&(Xt(`WARNING: gap detected between ${t.meta.endDate} and ${e.meta.startDate}`),o=t.data[t.data.length-1][2],r=Zt(a,o)),a<0&&(Xt("WARNING: gap was negative! This should NEVER happen!"),e.data=e.data.slice(Math.abs(a))),{meta:{startDate:t.meta.startDate,endDate:e.meta.endDate,interval:t.meta.interval,historyComplete:t.meta.historyComplete},data:[...t.data,...r,...e.data]}},Zt=function(t,e){return Array(t).fill([e,e,e])},Bt=function(t){var e;return Xt("getCommodityData"),e=ee(t),It(e)},Wt=function(t){return Xt("getForexPairData"),ee(t),{}},function(t){var e;for(e in t)t[e]&&(f[e]=!0)}({datamodule:!0,marketstackmodule:!0,scimodule:!0,startupmodule:!0}),({log:re,olog:ae}=y("scimodule"));var le,ue,ce,de,he,me,fe,ve,pe,ye,ge,we=function(){re("prepareAndExpose")};({log:de,olog:he}=y("tradovatemodule")),ge=null,ye=null;var Se=function(t){de("initialize")};pe=function(t){de("saveStorage"),t&&(ye=t),Rt("datahubState",ye)},ce=async function(t,e){var n,r,a,o;de("getRequest"),r={method:"GET",headers:{"Content-Type":"application/json",Accept:"application/json"}},null!=e&&(r.headers.Authorization=`Bearer ${e}`);try{a=await fetch(t,r)}catch(t){n=t,console.error(n)}try{if(a.ok)return await a.json();console.error("status: "+a.status),o=await a.text(),console.error(o)}catch(t){n=t,console.error(n)}},me=async function(t,e,n){var r,a,o,i;de("postRequest"),a={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)},null!=n&&(a.headers.Authorization=`Bearer ${n}`);try{o=await fetch(t,a)}catch(t){r=t,console.error(r)}try{if(o.ok)return await o.json();console.error("status: "+o.status),i=await o.text(),console.error(i)}catch(t){r=t,console.error(r)}},fe=async function(){var t,e;de("refreshToken"),e=ge+"/auth/renewAccessToken",t=await ce(e,ye.accessToken),he(t),null!=t.accessToken&&(ye.accessToken=t.accessToken),null!=t.mdAccessToken&&(ye.mdAccessToken=t.mdAccessToken),null!=t.expirationTime&&(ye.expirationTime=t.expirationTime),pe()},ve=async function(){var t,e,n;de("requestAccessToken"),e={name:null,password:null,appId:"sentinel",appVersion:null,cid:null,sec:null},n=ge+"/auth/accesstokenrequest",t=await me(n,e),he(t),null!=t&&pe(t)},ue=function(){var t,e,n,r;return de("ensureFreshToken"),null==(e=ye.expirationTime)?ve():(t=new Date(e).getTime(),n=(new Date).getTime(),he({exp:t,now:n,timeToExpiry:r=t-n}),r<0?ve():r<114e4?fe():void 0)},le=async function(){var t,e;de("checkSymbols"),de("using url: "+(e=ge+"/product/list")),t=await ce(e,ye.mdAccessToken),he(t)};var ke,Ee,De=async function(t){de("startSession"),t&&await ve(),await ue(),setInterval(ue,6e5),await le(),setInterval(le,36e5)};({log:ke,olog:Ee}=y("startupmodule"));var xe=async function(){ke("serviceStartup"),await ie()};const Te={configmodule:e,datamodule:i,dateutilsmodule:n,debugmodule:s,marketstackmodule:r,scimodule:l,startupmodule:c,storagemodule:a,symbolsmodule:o,tradovatemodule:u};global.allModules=Te,async function(){var t,n,r;try{return r=function(){var r;for(n in r=[],Te)null!=(t=Te[n]).initialize&&r.push(t.initialize(e));return r}(),await Promise.all(r),await Te.startupmodule.serviceStartup()}catch(t){return C("@run: "+t.message)}}()})();