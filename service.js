(()=>{"use strict";var e={n:t=>{var n=t&&t.__esModule?()=>t.default:()=>t;return e.d(n,{a:n}),n},d:(t,n)=>{for(var r in n)e.o(n,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:n[r]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{checkAccessMS:()=>D,checkSymbolsMS:()=>I,mrktStackSecret:()=>L,name:()=>U,persistentStateOptions:()=>V,trdvtCid:()=>J,trdvtPassword:()=>_,trdvtSecret:()=>F,trdvtUsername:()=>N,urlMrktStack:()=>B,urlTrdvt:()=>R,version:()=>G});var n={};e.r(n);var r={};e.r(r),e.d(r,{executeSpecialMission:()=>W,initialize:()=>Q});var o={};e.r(o),e.d(o,{prepareAndExpose:()=>X});var i={};e.r(i),e.d(i,{initialize:()=>be,startSession:()=>Ae});var s={};e.r(s),e.d(s,{serviceStartup:()=>Pe});const a=require("node:path");var u=e.n(a);const l=require("node:fs");var c,d,v=e.n(l);d=function(e){return JSON.stringify(e,null,4)},c={};var p=function(e){var t,n;return n=function(e){return t("\n"+d(e))},{log:t=function(t){c[e]&&console.log("["+e+"]: "+t)},olog:n}};const h=require("node:net");var y,f,m,g,E,k=e.n(h);({log:y,olog:f}=p("bugsnitch")),m=new Promise(function(e){return e}),E="unnamed",g=async function(e){var t;y("sendToBugsnitch"),await m,(t=k().createConnection("/run/bugsnitch.sk")).on("connect",function(){return t.end(e)}),t.on("error",function(e){return console.error(e)}),t.on("close",function(){return y("Connection closed!")})};var S,w,x,T,b=function(e){var t,n;if(y("report"),console.error(e),"string"!=typeof e)try{return n=`[${E}] Error: `+e.message,e.cause&&(n+="\n Cause: "+e.cause),e.stack&&(n+="\n Stack: "+e.stack),void g(n)}catch(e){t=e,console.error("bugsnitch.report: unexpected errorObject!\n "+t.message)}else g(n=`[${E}]: ${e}`)};w=Object.create(null);try{S=u().resolve(process.cwd(),"./.config.json"),x=v().readFileSync(S,"utf8"),w=JSON.parse(x)}catch(e){T="@configmodule - config parsing:\n",T+=" Local Config File could not be read or parsed!\n ",T+=e.message,b(T)}var j,O,A,P,M,C,q,z,$,F=w.secret||"none",J=w.cid||"none",N=w.name||"none",_=w.password||"none",L=w.mrktStackSecret||"none",R="https://live.tradovateapi.com/v1",B="https://api.marketstack.com/v2",D=6e5,I=36e5,U="Sentinel Datahub",G="v0.0.1",V={basePath:"../state",maxCacheSize:128};(function(e){var t;for(t in e)e[t]&&(c[t]=!0)})({bugsnitch:!0,marketstackmodule:!0,scimodule:!0,startupmodule:!0,tradovatemodule:!0}),({log:C,olog:q}=p("marketstackmodule")),j=null,O=null,u().resolve(".","symbols.json"),P=u().resolve(".","currencies.json"),A=[];var H,K,Q=function(e){C("initialize"),null!=e.mrktStackSecret&&(j=e.mrktStackSecret),null!=e.urlMrktStack&&(O=e.urlMrktStack)},W=async function(){C("executeSpecialMission"),await z(),C("sepcialMission ended... bye!")};$=function(e){return new Promise(function(t){return setTimeout(t,e)})},z=async function(){var e,t,n,r,o;for(C("storeRelevantCurrencies"),o=await M(),C(`results retrieved: ${o.length}`),q(o[0]),n=0,r=o.length;n<r;n++)t=o[n],A.push(t);e=JSON.stringify(A,null,4),v().writeFileSync(P,e)},M=async function(){var e,t,n,r,o,i,s;C("getAllCurrencies"),n=new URLSearchParams({access_key:j,limit:1e3,offset:0}),s=O+"/currencies?"+n.toString(),e=[];try{r=await fetch(s)}catch(e){t=e,console.error(t)}try{if(r.ok){if(null!=(o=await r.json()).error)throw new Error(o.error.code+": "+o.error.message);return C("retrieved result!"),q(o.pagination),q(o.data[0]),e.push(...o.data),1e3!==o.pagination.limit&&console.error(`Pagination Limit did not match our provided Limit! ${o.pagination.limit} vs 1000`),0!==o.pagination.offset&&console.error(`Pagination Offset did not match our offset! ${o.pagination.offset} vs 0`),e}console.error("status: "+r.status),i=await r.text(),console.error(i)}catch(e){t=e,console.error(t)}return e},({log:H,olog:K}=p("scimodule"));var X=function(){H("prepareAndExpose")};const Y=require("path"),Z=require("fs");var ee,te,ne,re,oe,ie,se,ae,ue,le,ce,de,ve,pe;te=Z.promises,re=function(e){var t;return t=e+".json",Y.resolve(null,t)},ne=function(e){return e+".backup"},ee=function(e){var t,n;t=ne(e);try{Z.copyFileSync(e,t)}catch(t){throw n="Error: backing up state failed!\n",n+="file: "+e+"\n",n+="reason: "+t.message,new Error(n)}},ve=function(e){return JSON.stringify(e,null,4)},ce={},de={},ie=null,ae=null,le={},se=0,oe=class{constructor(e){this.id=e,this.nextEntry=null,this.previousEntry=ie,null==ae&&(ae=this),null!=ie&&(ie.nextEntry=this),ie=this,le[this.id]=this,++se>64&&ue()}touch(){null!=this.nextEntry&&(null!=this.previousEntry?(this.nextEntry.previousEntry=this.previousEntry,this.previousEntry.nextEntry=this.nextEntry):(ae=this.nextEntry,this.nextEntry.previousEntry=null),this.nextEntry=null,this.previousEntry=ie,null!=ie&&(ie.nextEntry=this),ie=this)}remove(){return null!=this.nextEntry&&null!=this.previousEntry&&(this.nextEntry.previousEntry=this.previousEntry,this.previousEntry.nextEntry=this.nextEntry),null==this.nextEntry&&null==this.previousEntry&&(ie=null,ae=null),null!=this.nextEntry&&null==this.previousEntry&&(this.nextEntry.previousEntry=null,ae=this.nextEntry),null==this.nextEntry&&null!=this.previousEntry&&(this.previousEntry.nextEntry=null,ie=this.previousEntry),pe(this.id)}toString(){var e;return e=this.id+"\n",null!=this.nextEntry?e+="  next: "+this.nextEntry.id+"\n":e+="  next: null\n",null!=this.previousEntry?e+="  previous: "+this.previousEntry.id+"\n":e+="  previous: null\n",e}},pe=function(e){delete de[e],delete ce[e],delete le[e],se--},ue=function(){var e;null!=(e=ae)&&(null!=(ae=e.nextEntry)&&(ae.previousEntry=null),pe(e.id))};var he,ye,fe,me,ge,Ee,ke,Se,we,xe,Te;({log:me,olog:ge}=p("tradovatemodule")),Te=null,xe=null;var be=function(e){me("initialize")};we=function(e){me("saveStorage"),e&&(xe=e),async function(e,t){var n;null!=le[e]?le[e].touch():new oe(e),t&&(de[e]=t),(n=ve(de[e]))!==ce[e]&&(ce[e]=n,await function(e,t){var n;n=re(e),Z.writeFileSync(n,t),ee(n)}(e,n))}("datahubState",xe)},fe=async function(e,t){var n,r,o,i;me("getRequest"),r={method:"GET",headers:{"Content-Type":"application/json",Accept:"application/json"}},null!=t&&(r.headers.Authorization=`Bearer ${t}`);try{o=await fetch(e,r)}catch(e){n=e,console.error(n)}try{if(o.ok)return await o.json();console.error("status: "+o.status),i=await o.text(),console.error(i)}catch(e){n=e,console.error(n)}},Ee=async function(e,t,n){var r,o,i,s;me("postRequest"),o={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)},null!=n&&(o.headers.Authorization=`Bearer ${n}`);try{i=await fetch(e,o)}catch(e){r=e,console.error(r)}try{if(i.ok)return await i.json();console.error("status: "+i.status),s=await i.text(),console.error(s)}catch(e){r=e,console.error(r)}},ke=async function(){var e,t;me("refreshToken"),t=Te+"/auth/renewAccessToken",e=await fe(t,xe.accessToken),ge(e),null!=e.accessToken&&(xe.accessToken=e.accessToken),null!=e.mdAccessToken&&(xe.mdAccessToken=e.mdAccessToken),null!=e.expirationTime&&(xe.expirationTime=e.expirationTime),we()},Se=async function(){var e,t,n;me("requestAccessToken"),t={name:null,password:null,appId:"sentinel",appVersion:null,cid:null,sec:null},n=Te+"/auth/accesstokenrequest",e=await Ee(n,t),ge(e),null!=e&&we(e)},ye=function(){var e,t,n,r;return me("ensureFreshToken"),null==(t=xe.expirationTime)?Se():(e=new Date(t).getTime(),n=(new Date).getTime(),ge({exp:e,now:n,timeToExpiry:r=e-n}),r<0?Se():r<114e4?ke():void 0)},he=async function(){var e,t;me("checkSymbols"),me("using url: "+(t=Te+"/product/list")),e=await fe(t,xe.mdAccessToken),ge(e)};var je,Oe,Ae=async function(e){me("startSession"),e&&await Se(),await ye(),setInterval(ye,6e5),await he(),setInterval(he,36e5)};({log:je,olog:Oe}=p("startupmodule"));var Pe=async function(){je("serviceStartup"),await W()};const Me={configmodule:t,debugmodule:n,marketstackmodule:r,scimodule:o,startupmodule:s,tradovatemodule:i};global.allModules=Me,async function(){var e,n,r;try{return r=function(){var r;for(n in r=[],Me)null!=(e=Me[n]).initialize&&r.push(e.initialize(t));return r}(),await Promise.all(r),await Me.startupmodule.serviceStartup()}catch(e){return b("@run: "+e.message)}}()})();